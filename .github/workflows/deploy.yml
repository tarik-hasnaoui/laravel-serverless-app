name: Laravel Serverless CI/CD

on:
  push:
    branches: [main]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-west-1
      S3_BUCKET: laravel-serverless-media

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3Ô∏è‚É£ Build containers
      - name: Build Docker containers
        run: docker compose build

      # 4Ô∏è‚É£ Start services
      - name: Start Docker containers
        run: |
          docker compose up -d app nginx dynamodb minio
          sleep 15

      # 5Ô∏è‚É£ Composer install
      - name: Install dependencies
        run: docker compose exec app composer install --no-interaction --prefer-dist

      # 6Ô∏è‚É£ Prepare Laravel environment
      - name: Prepare Laravel environment
        run: |
          docker compose exec app php -r "file_exists('.env') || copy('.env.example', '.env');"
          docker compose exec app php artisan key:generate --force
          docker compose exec app php -r "file_exists('database/database.sqlite') || touch('database/database.sqlite');"

      # 7Ô∏è‚É£ Migrate SQLite
      - name: Run migrations
        run: docker compose exec app php artisan migrate --force

      # 8Ô∏è‚É£ Clear caches (zonder database cache errors)
      - name: Clear caches
        run: |
          docker compose exec app php artisan config:clear
          docker compose exec app php artisan route:clear
          docker compose exec app php artisan view:clear

      # 9Ô∏è‚É£ Run tests
      - name: Run tests
        run: docker compose exec app php artisan test

      # üîü Deploy to AWS Lambda (Serverless + Bref)
      - name: Deploy to AWS Lambda
        run: |
          docker compose exec \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=${{ env.AWS_REGION }} \
            -e SERVERLESS_ACCESS_KEY=${{ secrets.SERVERLESS_ACCESS_KEY }} \
            -w /var/www/html \
            app \
            serverless deploy --stage dev

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload assets to S3
      - name: Upload assets to S3
        run: |
          docker compose exec \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_REGION=${{ env.AWS_REGION }} \
            app \
            aws s3 sync public/ s3://${{ env.S3_BUCKET }}/ --delete
